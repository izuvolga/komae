<!DOCTYPE html>
<html>
  <head>
  <script>

/**
 * 霧（ガウシアンノイズ + ぼかし + 色付け）をSVGで生成
 * - 透明背景の上に、霧だけが描かれるレイヤーを返します
 * - 2層のフラクタルノイズをブレンドし、ガウシアンぼかしで柔らかく
 * - baseFrequency をゆっくりアニメして、モヤモヤが漂う表現に
 *
 * @param {Object} p
 * @param {number} [p.width=300]
 * @param {number} [p.height=300]
 * @param {string} [p.fogColor="#ffffff"]   - 霧の色（白寄り推奨）
 * @param {number} [p.opacity=0.55]         - 全体の不透明度（0〜1）
 * @param {number} [p.baseFrequency=0.012]  - 粒の大きさ（小さいほど大きな雲）
 * @param {number} [p.numOctaves=4]         - ノイズの複雑さ（2〜6）
 * @param {number} [p.blur=8]               - ぼかし半径
 * @param {number} [p.contrast=1.05]        - 霧のコントラスト（1前後）
 * @param {number} [p.speed=20]             - アニメ1周期（秒）
 * @param {number} [p.seed=2]               - 乱数シード（見た目固定用）
 * @param {boolean}[p.animate=true]         - 漂わせるなら true
 * @param {number} [edgeFeather=60]      端のフェザー幅(px)。大きいほど端で長く薄くなる
 * @param {"radial"|"none"} [edgeMode="radial"] 端のフェード方法（まずはラジアル推奨）
 * @returns {string} SVG文字列（透過背景の霧レイヤー）
 */
function generateFogSVG({
  width = 300,
  height = 300,
  fogColor = '#ffffff',
  opacity = 0.55,
  baseFrequency = 0.012,
  numOctaves = 4,
  blur = 8,
  contrast = 1.05,
  speed = 20,
  seed = 2,
  animate = true,
  edgeFeather = 60,
  edgeMode = 'radial',
} = {}) {
  // 2層ノイズ設定
  const bf1 = baseFrequency;
  const bf2 = +(baseFrequency * 1.6).toFixed(5);
  const seed2 = (seed >>> 0) + 1;

  const animVals1 = `${(bf1*0.75).toFixed(5)};${(bf1*1.05).toFixed(5)};${(bf1*0.9).toFixed(5)};${(bf1*0.75).toFixed(5)}`;
  const animVals2 = `${(bf2*0.75).toFixed(5)};${(bf2*1.05).toFixed(5)};${(bf2*0.9).toFixed(5)};${(bf2*0.75).toFixed(5)}`;

  const alphaExponent = Math.max(0.5, Math.min(2.0, contrast));
  const alphaSlope    = Math.max(0, Math.min(1, opacity));

  // フェザー（ラジアル）用のストップ位置を計算
  // r=0.5（箱の半径）で完全に0。そこに至る手前 edgeFeather 分をフェード帯にする。
  const halfMin = Math.min(width, height) / 2;                // 中心から短辺の端まで
  const fr = Math.max(0, Math.min(1, edgeFeather / halfMin)); // 0..1
  const stopOpaque = (1 - fr).toFixed(4);   // ここまでは不透明=1
  // 注意: 角もちゃんと0になるよう、ラジアルは r=50%（外は自動で0=pad）

  return `
<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}"
     xmlns="http://www.w3.org/2000/svg" role="img" aria-label="fog">
  <defs>
    <!-- 霧そのもの（前回と同様） -->
    <filter id="fogFilter" x="-50%" y="-50%" width="200%" height="200%" color-interpolation-filters="sRGB">
      <feTurbulence type="fractalNoise" baseFrequency="${bf1}" numOctaves="${numOctaves}"
                    seed="${seed}" stitchTiles="stitch" result="n1">
        ${animate ? `<animate attributeName="baseFrequency" values="${animVals1}" dur="${speed}s" repeatCount="indefinite"/>` : ''}
      </feTurbulence>
      <feTurbulence type="fractalNoise" baseFrequency="${bf2}" numOctaves="${Math.max(2, numOctaves-1)}"
                    seed="${seed2}" stitchTiles="stitch" result="n2">
        ${animate ? `<animate attributeName="baseFrequency" values="${animVals2}" dur="${(speed*1.3).toFixed(1)}s" repeatCount="indefinite"/>` : ''}
      </feTurbulence>
      <feBlend in="n1" in2="n2" mode="screen" result="noise"/>
      <feColorMatrix in="noise" type="luminanceToAlpha" result="alpha"/>
      <feGaussianBlur in="alpha" stdDeviation="${blur}" result="soft"/>
      <feComponentTransfer in="soft" result="alphaAdj">
        <feFuncA type="gamma" amplitude="${alphaSlope}" exponent="${alphaExponent}" offset="0"/>
      </feComponentTransfer>
      <feFlood flood-color="${fogColor}" flood-opacity="1" result="fogColor"/>
      <feComposite in="fogColor" in2="alphaAdj" operator="in" result="fog"/>
      <feMerge><feMergeNode in="fog"/></feMerge>
    </filter>

    <!-- 端で薄くなるラジアル・フェザーマスク -->
    ${edgeMode === 'radial' ? `
    <radialGradient id="edgeFadeGrad" cx="50%" cy="50%" r="50%" gradientUnits="objectBoundingBox" spreadMethod="pad">
      <stop offset="0"   stop-color="white"/>
      <stop offset="${stopOpaque}" stop-color="white"/>
      <stop offset="1"   stop-color="black"/>
    </radialGradient>
    <mask id="edgeFadeMask" maskUnits="objectBoundingBox">
      <rect x="0" y="0" width="${width}" height="${height}" fill="url(#edgeFadeGrad)"/>
    </mask>` : ''}

  </defs>

  <!-- 透明な矩形に霧フィルタを適用し、端フェザーのマスクをかける -->
  <rect x="0" y="0" width="100%" height="100%" fill="none"
        filter="url(#fogFilter)" ${edgeMode === 'radial' ? 'mask="url(#edgeFadeMask)"' : ''}/>
</svg>`;
}

document.addEventListener('DOMContentLoaded', () => {
  document.body.innerHTML = generateFogSVG({
    width: 300,
    height: 300,
    fogColor: '#ff0000',
    opacity: 1.0,       // 霧の濃さ（全体）
    baseFrequency: 0.034,// 粒の大きさ
    numOctaves: 10,       // 複雑さ
    blur: 10,            // 柔らかさ
    contrast: 1.05,      // 霧のコントラスト
    speed: 5,           // 漂い速度（秒）
    seed: 42,            // 見た目を固定
    animate: false,
    edgeFeather: 100,     // 端のフェザー幅（px）
    edgeMode: 'radial',  // ラジアルフェード
  });
});
  </script>
  </head>
  <body>
  </body>
</html>
